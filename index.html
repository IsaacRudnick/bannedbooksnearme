<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Banned Books Lookup</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<style>
			.book-card img {
				height: 280px;
				object-fit: cover;
			}
			.book-card:hover {
				transform: translateY(-4px);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
			}
			#suggestions {
				max-height: 200px;
				overflow-y: auto;
				z-index: 1000;
				width: 200px;
			}
		</style>
	</head>
	<body class="bg-light">
		<div class="container py-4">
			<h1 class="text-center mb-4">Banned Books Lookup</h1>
			<form id="search-form" autocomplete="off" class="text-center mb-4">
				<div class="input-group justify-content-center">
					<input
						type="text"
						name="state"
						id="state-input"
						class="form-control w-auto"
						placeholder="Enter state abbreviation (e.g., CA)"
						required
					/>
					<button type="submit" class="btn btn-primary">Search</button>
				</div>
				<div id="suggestions" class="list-group position-absolute"></div>
			</form>

			<div id="results-container" class="d-none">
				<h2 id="results-title" class="mb-3"></h2>
				<div id="book-grid" class="row g-4"></div>
				<div class="text-center mt-3">
					<button id="load-more" class="btn btn-secondary">Load More</button>
				</div>
			</div>
		</div>

		<!-- Placeholder for modals -->
		<div id="modals-container"></div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			const PAGE_SIZE = 12;
			let allBooks = [];
			let booksData = [];
			let currentIndex = 0;
			let currentState = "";

			// --- State autocomplete ---
			const states = [
				"AL",
				"AK",
				"AZ",
				"AR",
				"CA",
				"CO",
				"CT",
				"DE",
				"FL",
				"GA",
				"HI",
				"ID",
				"IL",
				"IN",
				"IA",
				"KS",
				"KY",
				"LA",
				"ME",
				"MD",
				"MA",
				"MI",
				"MN",
				"MS",
				"MO",
				"MT",
				"NE",
				"NV",
				"NH",
				"NJ",
				"NM",
				"NY",
				"NC",
				"ND",
				"OH",
				"OK",
				"OR",
				"PA",
				"RI",
				"SC",
				"SD",
				"TN",
				"TX",
				"UT",
				"VT",
				"VA",
				"WA",
				"WV",
				"WI",
				"WY",
			];
			const input = document.getElementById("state-input");
			const suggestionsContainer = document.getElementById("suggestions");

			input.addEventListener("input", () => {
				const query = input.value.toLowerCase();
				suggestionsContainer.innerHTML = "";
				if (!query) return;
				const matches = states.filter((state) => state.toLowerCase().includes(query));
				matches.forEach((match) => {
					const div = document.createElement("button");
					div.type = "button";
					div.className = "list-group-item list-group-item-action";
					div.innerText = match;
					div.onclick = () => {
						input.value = match;
						suggestionsContainer.innerHTML = "";
					};
					suggestionsContainer.appendChild(div);
				});
			});
			document.addEventListener("click", (e) => {
				if (e.target !== input) suggestionsContainer.innerHTML = "";
			});

			// --- Load JSON once ---
			async function loadAllBooks() {
				if (allBooks.length === 0) {
					const response = await fetch("books.json");
					allBooks = await response.json();
				}
			}

			// --- Handle form submit ---
			document.getElementById("search-form").addEventListener("submit", async (e) => {
				e.preventDefault();
				await loadAllBooks();

				currentState = input.value.trim().toLowerCase();
				booksData = allBooks.filter((b) => b.state.trim().toLowerCase() === currentState);

				currentIndex = 0;
				document.getElementById("book-grid").innerHTML = "";
				document.getElementById("modals-container").innerHTML = "";
				document.getElementById("results-container").classList.remove("d-none");

				const resultsTitle = document.getElementById("results-title");
				if (booksData.length) {
					resultsTitle.textContent = `Results for ${currentState.toUpperCase()}`;
					renderBooks();
					document.getElementById("load-more").style.display = "block";
				} else {
					resultsTitle.textContent = `No banned books found for ${currentState.toUpperCase()}`;
					document.getElementById("load-more").style.display = "none";
				}
			});

			// --- Render next page of books ---
			function renderBooks() {
				const slice = booksData.slice(currentIndex, currentIndex + PAGE_SIZE);
				const grid = document.getElementById("book-grid");
				const modals = document.getElementById("modals-container");

				slice.forEach((book, i) => {
					const idx = currentIndex + i + 1;

					// Card
					const card = document.createElement("div");
					card.className = "col-md-3";
					card.innerHTML = `
						<div class="card book-card h-100" role="button" data-bs-toggle="modal" data-bs-target="#modal-${idx}">
							${
								book.cover_url
									? `<img src="${book.cover_url}" class="card-img-top" alt="Cover of ${book.title}" onerror="this.style.display='none'">`
									: ""
							}
							<div class="card-body">
								<h6 class="card-title">${book.title}</h6>
								<p class="card-text text-muted">${book.author || ""}</p>
							</div>
						</div>
					`;
					grid.appendChild(card);

					// Modal
					const modal = document.createElement("div");
					modal.className = "modal fade";
					modal.id = `modal-${idx}`;
					modal.tabIndex = -1;
					modal.innerHTML = `
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">${book.title}</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
								</div>
								<div class="modal-body">
									<p><em>by ${book.author}</em></p>
									<p><strong>Source:</strong> ${book.source}</p>
									<p><strong>District:</strong> ${book.district}</p>
									<p><strong>Availability:</strong> ${book.availability}</p>
									<p><a href="${book.worldcat}" target="_blank" class="btn btn-outline-primary">Find in WorldCat</a></p>
								</div>
							</div>
						</div>
					`;
					modals.appendChild(modal);
				});

				currentIndex += PAGE_SIZE;
				if (currentIndex >= booksData.length) {
					document.getElementById("load-more").style.display = "none";
				}
			}

			document.getElementById("load-more").addEventListener("click", renderBooks);
		</script>
	</body>
</html>

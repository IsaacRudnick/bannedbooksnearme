<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Banned Books Lookup</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
		<style>
			.book-card img {
				height: 280px;
				object-fit: cover;
			}
			.book-card:hover {
				transform: translateY(-4px);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
			}
		</style>
	</head>
	<body class="bg-white">
		<div class="container py-4">
			<h1 class="text-center mb-4">Banned Books Lookup</h1>
			<div class="text-center mb-4">
				<p class="mb-3">Click on a state to see banned books in that area:</p>
				<div id="map" style="max-width: 800px; margin: 0 auto"></div>
			</div>

			<div id="results-container" class="d-none">
				<h2 id="results-title" class="mb-3"></h2>
				<div id="book-grid" class="row g-4"></div>
				<div class="text-center mt-3">
					<button id="load-more" class="btn btn-secondary">Load More</button>
				</div>
			</div>
		</div>

		<!-- Placeholder for modals -->
		<div id="modals-container"></div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script type="text/javascript" src="public/mapdata.js"></script>
		<script type="text/javascript" src="public/usmap.js"></script>
		<script type="text/javascript" src="public/select.js"></script>
		<script>
			const PAGE_SIZE = 12;
			let allBooks = [];
			let booksData = [];
			let currentIndex = 0;
			let currentState = "";

			// Initialize the map
			simplemaps_select.map = simplemaps_usmap; // tells the script which map to work with
			simplemaps_select.selected_color = "#007bff"; // Bootstrap primary blue
			simplemaps_select.max = 1;

			// Set up the click hook function
			simplemaps_usmap.hooks.click_state = function (id) {
				// This function is called when a state is clicked
				handleStateSelection(id);
			};

			// --- Load JSON once ---
			async function loadAllBooks() {
				if (allBooks.length === 0) {
					const response = await fetch("books.json");
					const rawBooks = await response.json();

					// Remove duplicate books based on title only
					const seen = new Set();
					allBooks = rawBooks.filter((book) => {
						// Create a unique key using only the title
						const key = (book.title || "").toLowerCase().trim();

						if (seen.has(key)) {
							return false; // Skip duplicate
						}

						seen.add(key);
						return true; // Keep this book
					});

					console.log(`Loaded ${rawBooks.length} books, kept ${allBooks.length} after removing duplicates`);
				}
			}

			// --- Handle state selection from map ---
			async function handleStateSelection(state_id) {
				await loadAllBooks();

				currentState = state_id.toLowerCase();
				booksData = allBooks.filter((b) => b.state.trim().toLowerCase() === currentState);

				currentIndex = 0;
				document.getElementById("book-grid").innerHTML = "";
				document.getElementById("modals-container").innerHTML = "";
				document.getElementById("results-container").classList.remove("d-none");

				const resultsTitle = document.getElementById("results-title");
				if (booksData.length) {
					resultsTitle.textContent = `Results for ${currentState.toUpperCase()}`;
					renderBooks();
					document.getElementById("load-more").style.display = "block";
				} else {
					resultsTitle.textContent = `No banned books found for ${currentState.toUpperCase()}`;
					document.getElementById("load-more").style.display = "none";
				}
			}

			// --- Render next page of books ---
			function renderBooks() {
				const slice = booksData.slice(currentIndex, currentIndex + PAGE_SIZE);
				const grid = document.getElementById("book-grid");
				const modals = document.getElementById("modals-container");

				slice.forEach((book, i) => {
					const idx = currentIndex + i + 1;

					// Card
					const card = document.createElement("div");
					card.className = "col-md-3";
					card.innerHTML = `
						<div class="card book-card h-100" role="button" data-bs-toggle="modal" data-bs-target="#modal-${idx}">
							${
								book.cover_url
									? `<img src="${book.cover_url}" class="card-img-top" alt="Cover of ${book.title}" onerror="this.style.display='none'">`
									: ""
							}
							<div class="card-body">
								<h6 class="card-title">${book.title}</h6>
								<p class="card-text text-muted">${book.author || ""}</p>
							</div>
						</div>
					`;
					grid.appendChild(card);

					// Modal
					const modal = document.createElement("div");
					modal.className = "modal fade";
					modal.id = `modal-${idx}`;
					modal.tabIndex = -1;

					// Check if book can be borrowed online
					const canBorrowOnline = book.availability === "Can be borrowed online";
					const linkUrl = canBorrowOnline ? `https://openlibrary.org${book.openLibraryKey}` : book.worldcat;
					const linkText = canBorrowOnline ? "Borrow Online" : "Find in WorldCat";
					const linkClass = canBorrowOnline ? "btn btn-success" : "btn btn-outline-primary";

					modal.innerHTML = `
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">${book.title}</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
								</div>
								<div class="modal-body">
									<p><em>by ${book.author}</em></p>
									<p><strong>Source:</strong> ${book.source}</p>
									<p><strong>District:</strong> ${book.district}</p>
									<p><strong>Availability:</strong> ${book.availability}</p>
									<p><a href="${linkUrl}" target="_blank" class="${linkClass}">${linkText}</a></p>
								</div>
							</div>
						</div>
					`;
					modals.appendChild(modal);
				});

				currentIndex += PAGE_SIZE;
				if (currentIndex >= booksData.length) {
					document.getElementById("load-more").style.display = "none";
				}
			}

			document.getElementById("load-more").addEventListener("click", renderBooks);
		</script>
	</body>
</html>
